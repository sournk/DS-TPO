# DS-TPO: Time Price Opportunity (TPO)
Торговая система для MetaTrader 5, которая использует Time Price Opportunity (TPO) подход

* Разработчик: Denis Kislitsyn | denis@kislitsyn.me | [kislitsyn.me](https://kislitsyn.me)
* Версия: 0.1.6

## Торговая стратегия

Бот использует индикатор [TPO Profile MT5](https://www.mql5.com/en/market/product/62781) для входа в сделки в двух режимах:

**Режим 1. Naked Point Of Control (NPOC)**. Используются непротестированные POC прошлых периодов для потенциальных сделок.
**Режим 2. Single Prints (SP)**.  Используются крайние одиночные блоки ("хвосты") текущего профиля TPO для потенциальных сделок.

### Режим 1. Naked Point Of Control (NPOC)

- [x] 1. Индикатор строит на графике профили TPO на каждый день. 
- [x] 2. В каждом TPO профиле индикатор рисует уровень POC.
- [x] 3. Бот находит на графике все уровни POC на каждой новой свече на TF `POCTF`.
- [x] 4. Бот классифицирует каждый POC как поддержку (SUP) или сопротивление (RES). Тип зависит от положения POC относительно цены открытия следующего дня. Если POC выше цены открытия, то POC определяется как RES. Иначе - SUP. 
- [x] 5. Бот исключает POC текущего дня, потому что профиль сформирован не до конца и POC в течение дня меняется много раз.
- [x] 6. Бот исключает POC, которые были протестированы, начиная со следующего дня. День формирования профиля не учитывается, потому что POC двигался в этом дне много раз. Бот проверяет все последующие дни.
- [x] 7. Все оставшиеся уровни - это NPOC - потенциальные зоны для входа в сделку.
- [x] 8. Касание зоны NPOC активирует режим ожидания слома структуры в обратную сторону (на отскок) на младшем TF:
    - [x] 8.1. После касания NPOC бот определяет HIGH и LOW вокруг уровня.
    - [x] 8.2. Левая вершина/впадина устанавливает текущий BOS уровень.
    - [x] 8.3. Бот может обновляет BOS много раз после каждого перехая/перелоя текущего экстремума.
    - [x] 8.4. Новый BOS - это вершина/впадина, предшествующая новому экстремуму.
    - [x] 8.5. Любые вершины внутри текущих HIGH и LOW игнорируются.
    - [x] 8.6. Бот использует стандартный индикатор ZigZag для определения вершин структуры. Поэтому в настройках можно подобрать параметры для более грубого или точного определения экстремумов.
- [x] 9. Бот входит в сделку после подтверждения слома структуры - пробития актуального уровня BOS.
    - [x] 9.1. Если текущая цена хуже цены уровня NPOC, то бот размещает отложенный STOP ордер.
    - [x] 9.2. Если текущая лучше цены уровня NPOC, то бот входит по рынку.
- [x] 10. Бот устанавливает SL и TP ордера или позиции на фиксированных дистанциях от уровня.

### Режим 2. Single Prints (SP)
- [x] 1. Бот анализирует профиль TPO текущего дня на каждом тике.
- [x] 2. После образования достаточного количества SP (одиночных блоков) сверху (RES) или снизу (SUP) профиля бот переходит в режим ожидания слома структуры в обратную сторону (на отскок) на младшем TF.
- [x] 3. Бот определяет вход в позицию после слома структуры (BOS) также как [Режиме 1](#режим-1-naked-point-of-control-npoc).
- [x] 4. Вход происходит либо лимитным ордером, либо по рынку от уровня BOS с фиксированными дистанциями SL и TP в пунктах.
- [x] 5. После образования SP любого вида RES или SUP повторное образование SP в этот день игнорируется, потому что SP могут исчезать и появляться в профиле в течение дня много раз.


## Установка
1. Убедитесь, что ваш терминал MetaTrader 5 обновлен до последней версии. Для тестирования советников рекомендуется обновить терминал до самой последней бета-версии. Для этого запустите обновление из главного меню `Help->Check For Updates->Latest Beta Version`. На прошлых версиях советник может не запускаться, потому что скомпилирован на последней версии терминала. В этом случае вы увидите сообщения на вкладке `Journal` об этом.
2. Установите индикатор `TPO Profile MT5` из Маркета вашего терминала. Для этого обязательно нужно завести аккаунт на сайте mql5.com и ввести логин и пароль в самом терминале. Далее в поиске ввести `TPO Profile MT5`. Перейти на страницу индикатора и скачать тестовую версию или купить полную.
    1. Для тестирования достаточно бесплатно установить демоверсию индикатора. Для тестирования в режиме Тестера стратегий этого достаточно. Демоверсию индикатора нельзя использовать в режиме рынка.
    2. Чтобы запустить бот в режиме рынка нужно купить и установить платную полную версию в ваш терминал.
    > **ВАЖНО!** 
    > - Платная версия индикатора привязывается к компьютеру, на котором она скачена и установлена. Поэтому **для реальной торговли нужно купить индикатор из терминала, который установлен на рабочем VPS**.
    > - **Перенести купленный индикатор на другой терминал невозможно** простым копированием файла индикатора.
3. Скопируйте исполняемый файл бота `*.ex5` в каталог данных терминала `MQL5\Experts\`.
4. Скопируйте исполняемый файл индикатора `*.ex5` в каталог данных терминала `MQL5\Indicators\`.
5. Откройте график пары.
6. Переместите советника из окна Навигатор на график.
7. Установите в настройках бота галочку `Allow Auto Trading`.
8. Включите режим автоторговли в терминале, нажав кнопку `Algo Trading` на главной панели инструментов.

## Настройки

##### 1. ОСНОВНЫЕ НАСТРОЙКИ

- [x] `Mode`: Режим `Naked POC` или `Single Prints`.
- [x] `MMType`: Тип расчета лота *(0.1.1)*:
    - `Fixed lot`: Фиксированный лот, который установлен в параметре `MMValue`.
    - `% of balance`: Бот рассчитает объема лота в валюте депозита как % от текущего баланса, который установлен в параметре `MMValue`.
    - `% of Equity`: Аналогично `% of balance`, только база - это текущее значение средств.
    - `% of free margin`: Аналогично `% of balance`, только база - это текущее значение свободной маржи.
    - `Auto (limit % of risk)`: В этом режиме бот рассчитает лот таким образом, чтобы максимальный убыток позиции/ордера по его SL не превысил % от депозита или средств (что в текущий момент меньше).
- [x] `SLMode`: Режим SL *(0.1.1)*: 
    - `Фиксированная дистанция, пункт`: бот установит SL на фиксированное расстояние из параметра `SLDist`.
    - `BOS вершина перед пробитием`: бот найдет ближайшую вершину справа от BOS и установит SL в это значение.
    - `Вершина после POC`: бот найдет следующую после POC вершину и установит SL в это значение.
        > **ВАЖНО!!!**  
        > Если BOS сместится ниже SL, то бот не сможет открыть ордер или позицию со SL выше точки входа, поэтому сетап будет пропущен.
    - `Экстремум между BOS и POC`: бот найдет экстремум между POС и пробитием BOS и установит SL в это значение.
    - `Экстремум между BOS и пробитием`: бот найдет экстремум между началом и пробитием BOS и установит SL в это значение.
- [x] `SLDist`: Фиксированная дистанция SL, пункт *(0.1.1)*.
- [x] `SLDistMaxAllowed`: Макс. допустимая дистанция SL, пункт *(0.1.1)*. Если SL превысит эту дистанцию, то бот пропустит сделку.
- [x]  `TPMode`: Режим TP:
    - `Фиксированная дистанция, пункт`: Дистанция TP устанавливается в параметре `TPDist`.
    - `Мультипликатор RR`: TP будет рассчитан как SL умноженный на мультипликатор из параметра `TPRRRatio`.
    - `POC профиля TPO текущего дня`: TP будет установлен в POC профиля текущего дня.
    - `Ближний VAL/VAH профиля TPO текущего дня`: TP будет установлен в ближний к текущей цене VAL или VAH.
    - `Дальний VAL/VAH профиля TPO текущего дня`: TP будет установлен в дальний к текущей цене VAL или VAH.
    > **ВАЖНО!!!**
    > В режимах установки TP в POC или VAH/VAL возможны ситуации, когда установить TP в эту цену невозможно, потому что эти уровне уже хуже текущей цены, пробития BOS. В этих случаях TP будет установлен по `Мультипликатору RR`.
- [x] `TPDist`: Фиксированная дистанция TP, пункт
- [x] `TPRRRatio`: Мультипликатор RR для TP
- [x] `OrderExpirationMin`: Время истечения ордеров, мин (0-откл) *(0.1.3)*

##### 2. TPO PROFILE
- [x] `TPOShowVolText:` Show Time Text
- [x] `InpTPOinpOnChartNumOfSteps`: Number Of Price Steps

##### 3. NAKED POC
- [x] `POCTF`: POC detection TF. Таймфрейм на появлении свечи которого бот обновляет POC.
- [x] `POCShiftMode`: Вид сдвига POC *(0.1.1)*: 
    - `Нет`: POC совпадает с POC TPO профиля.
    - `На ближайшую границу POC блока (если возможно)`: Для SUP - верхняя граница, для RES - нижняя.
    > **ВАЖНО!!!**
    > Если цена открытия дня окажется между POC и границей блока, то сдвиг не будет выполнен, уровень останется оригинальным POC.
- [x] `POC.ShiftEdgeNum`: Номер блока для сдвига POC.

##### 4. SINGLE PRINTS
- [x] `PSupCnt`: Мин. кол. SP поддержки, шт
- [x] `PSupCnt`: Мин. кол. SP сопротивления, шт
- [x] `SPMaxDayEntryCnt`: Макс. сделок в одном направлении в день, шт *(0.1.1)*

##### 5. BOS
- [x] `BOSTF`: ==BOS detection TF: Таймфрейм для определения и отслеживания BOS.==
- [x] `BOSMode`: Режим поиска экстремумов BOS: `ZigZag` или `Fractal`.
- [x] `BOSZZDepth`: BOS ZigZag Depth. Глубина сегмента ZigZag.
- [x] `BOSZZBackstep`: BOS ZigZag Backstep. Количество шагов ZigZag.
- [x] `BOSFractalLeftBarCount`: Свечей фрактала от вершины слева, шт. *Чем больше это число, тем строже поиск фрактала. Валидными будет фрактал, у которого слева от центральной свечи свечи упорядочены по H/L.*
- [x] `BOSFractalRightBarCount`: Свечей фрактала от вершины справа, шт. *Аналогично `BOSFractalLeftBarCount`.*
- [x] `BOSFractalLowSorted`: LOW свечей должны быть упорядочен. *Этот параметр сделает поиск фракталов еще жестче. Если включен, то еще и нижняя часть свечей должна быть упорядочена, для валидного фрактала.*

##### 6. ФИЛЬТР ПО ATR
- [x] `ATR.SL.Enable`: Фильтр SL по ATR включен?
- [x] `ATR.SL.Ratio`: Мультипликатор ATR для фильтра SL
- [x] `ATR.EP.Enable`: Фильтр EP по ATR включен?
- [x] `ATR.EP.Ratio`: Мультипликатор ATR для фильтра EP
- [x] `ATR.TF`: Таймфрейм ATR
- [x] `ATR.Period`: Период ATR

##### 7. ФИЛЬТР ВРЕМЕНИ
- [x] `TFEnable`: Фильтр по времени включен? Фильтр ограничивает поиск ботом POC или SP.
- [x] `TFStart`: Первый час работы
- [x] `TFFinish`: Последний час работы (включительно)

##### 8. ДОПОЛНИТЕЛЬНЫЕ НАСТРОЙКИ
- [x] `Magic`: Идентификатор эксперта
- [x] `GP`: Префикс комментариев и графики
- [x] `MS.CE`: Comment Enable (turn off with no visual for speed)

### Рекомендации по тестированию
1. Определение BOS и входы в сделки бот выполняет на M1, поэтому рекомендую запускать и тестировать бота на M1, чтобы увидеть все изменения POC, SP, BOS в реальном времени. На графиках старших TF эти изменения практически незаметны.
2. Рекомендуется использовать режим моделирования "Every tick".

> **ВАЖНО!**
Индикатор `TPO Profile MT5` не предоставляет численные буферы по профилям и уровням для экспертов, поэтому бот постоянно мониторит все изменения на графике и получает информацию о профилях TPO сканирую объекты на графике. В таком режиме бот работает медленнее, чем с обычными числовыми индикаторами.

### Вспомогательная графика 
![alt text](img/UM001.%20Chart%20Overview.png)

## Замечания 09.07.24

**Режим NPOC:**

- [x] 1. Добавить сдвиг POC на фиксированную дистанцию, чтобы входить не от середины диапазона POC, а от границ.
    **Добавлен параметр `POCShiftMode`.**
- [x] 2. Добавить режим динамического SL - за последний HIGH/LOW.
    **Добавлен параметр `SLMode`.**
- [x] 3. Добавить ограничение максимальной дистанции SL. При превышении не входить в сделки.
    **Добавлен параметр `SLDistMaxAllowed`.**
- [x] 4. Добавить динамический расчет лота от SL и макс. % риска.
    **Добавлен параметр `SLDistMaxAllowed`.**
- [x] 5. Добавить режимы TP: а) POC; б) VAL/VAH; в) Мультипликатор RR.
    **Добавлен параметр `TPMode`.**
- [x] 6. **Отложено**: Заменить ZigZag на Fractals для поиска BOS.
- [x] 7. **Отложено**: Получать POC от FX CME через TV или другие платформы.

**Режим SP:**
- [x] 1. Ошибочный вход в SELL от нижних SP 2024.04.17 08:57 EURUSD.
- [x] 2. Добавить фильтр входов при пробои BOS, если SP уже неактуальны.
- [x] 3. Добавить параметры сколько раз в день можно входить от SP.
    **Добавлен параметр `SPMaxDayEntryCnt`.**
- [ ] 4. **Под вопросом**: В индикаторе `TPO Profile MT5` нет настройки объединения блоков по M30, только H1. 

## Замечания 09.07.24

- [x] 1. Ошибка расчета TP по RR: XAUUSD 2020.01.08 18:13 и 2020-01-13 11:29.
- [x] 2. Дополнительная опция поиска дальнего от BOS для установки SL (вместо ближнего).
- [x] 3. Добавить отмену ордеров. Могу сделать. Жду правила отмены. ==см. [Замечания от 17.07.24](#замечания-170724)==
- [ ] 4. **Под вопросом**: Дополнительная опция проверки SP для входов даже в режиме NPOC. К этой опции вернемся после сдачи основного функционала.


## Замечания 15.07.24
Мы тестировали на EURUSD и на XAUUSD за 01.01.2020 до 01.04.2020.

- [x] 1. Вход в позицию в 00:00, хотя в настройках мы выбрали тайм ренж, когда входы допустимы
![alt text](img/UM002.%20telegram-cloud-photo-size-2-5235654113117724330-y.jpg)
- [x] 2. Здесь непонятно почему не был взял лой для боса. Может мы можем как-то настроить зигзаг? Настройка была 3 депф и 1 бекстеп
- [x] 3. И самое главное это расчет стопов и тейков, здесь стоп далего за границами проторгованной цены за день.
![alt text](img/UM003.%20telegram-cloud-photo-size-2-5235654113117724325-y.jpg)


## Замечания 17.07.24
- [x] 4.8. Ограничить по времени входы в сделки дополнительно к поиску POC.
- [x] 4.9. BOS определять по простому фракталу: hHh/lLl вместо ZZ.
- [x] 4.10. Добавить 3-ий режим определения SL: экстремум между точкой входа и началом BOS.
- [x] 4.11. Добавить фильтр входа в сделку, если SL превышает ATR в X раз.
- [x] 4.12. Добавить фильтр входа в сделку, если расстояние от входа до NPOC превышает ATR в X раз.
- [x] 4.13. Добавить 3-ий режим сдвига NPOC: на X границ блоков.
- [x] ==4.14. Добавить выбор TF для поиска BOS.==

## Замечания 24.07.24
- [x] 4.15. Сдвигать BOS на предыдущий пик фрактала после образования H/L цены, не дожидаясь пика фрактала/зигзага. 
    *Подробнее: Дотронулись зоны РОС > мы определили последний фрактал хай перед касанием РОС и нам нужно при дальнейшем обновлении лоев искать новый фрактал хай. Если обновления не было, то мы используем тот же фрактал хай, но если мы получаем новый лоу и новый фрактал хай — мы берем его как бос*.
- [x] 4.16. Добавить режим входа в сделку `Агресивный`. После пробития BOS на тике входить по рынку. 
- [x] 4.17.а. Добавить режим входа в сделку `Консервативный`. После закрытия свечи выше/ниже BOS размещать отложенные ордера: а) STOP для цены ниже BOS; б) LIMIT для цены выше BOS. 
- [x] 4.17.б. Убрать режим входа STOP ордером от POC. Входы будут только от BOS.
- [x] 4.18. Добавить опциональный фильтр входа в сделки по наличию нужного количества SP профиля текущего дня.
- [ ] 4.19. Отменять отложенные ордера, если цена выше/ниже TP.
